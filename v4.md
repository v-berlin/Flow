# Flow v4 - Kritische Bugfixes

## ğŸ› Was wurde behoben?

In dieser Version wurden zwei kritische Fehler behoben, die die KernfunktionalitÃ¤t von Flow beeintrÃ¤chtigt haben:

### Problem 1: Timer speichert keine Zeit âŒ â†’ âœ…
**Symptom:** Wenn du den Timer stoppst, wird die getrackte Zeit nicht gespeichert. Der Progress bleibt bei 0, obwohl du gearbeitet hast.

**Ursache:** Der Code hat die Start-Zeit nicht korrekt aus dem `input_datetime.flow_timer_start` Helfer gelesen. Er hat versucht, einen String-Wert zu verwenden, anstatt den Timestamp-Attribut.

**LÃ¶sung:** Die Timer-Stop-Sequenz wurde korrigiert. Jetzt verwendet sie `state_attr('input_datetime.flow_timer_start', 'timestamp')` statt `states('input_datetime.flow_timer_start')`.

### Problem 2: Mehrere Kategorien gleichzeitig aktiv âŒ â†’ âœ…
**Symptom:** Du kannst Work, Personal, Coding usw. gleichzeitig aktivieren, obwohl immer nur eine Kategorie aktiv sein sollte.

**Ursache:** Die Kategorie-Auswahl-Automation hatte eine Race-Condition. Wenn eine Kategorie aktiviert wurde, wurden die anderen deaktiviert, aber die aktivierte Kategorie wurde nicht explizit wieder eingeschaltet. AuÃŸerdem war der Modus auf "single" gesetzt, was bedeutete, dass schnelle aufeinanderfolgende Ã„nderungen ignoriert wurden.

**LÃ¶sung:** Die Automation wurde verbessert mit:
- Explizites Einschalten der gewÃ¤hlten Kategorie nach dem Ausschalten der anderen
- Ã„nderung des Modus von "single" auf "queued" mit max: 5
- Bessere Reihenfolge der Aktionen

---

## ğŸ”§ Was musst du jetzt tun?

### Schritt 1: Automationen aktualisieren

Du musst zwei Automationen in deinem Home Assistant aktualisieren:

#### Automation 1: "Flow: Timer Toggle Handler" aktualisieren

1. Gehe zu **Einstellungen** â†’ **Automationen & Szenen** â†’ **Automationen**
2. Suche die Automation **"Flow: Timer Toggle Handler"**
3. Klicke darauf und dann auf die **drei Punkte** (â‹®) oben rechts
4. WÃ¤hle **"In YAML bearbeiten"**
5. Suche diese Zeile (ungefÃ¤hr Zeile 45-46):
   ```yaml
   start_time: "{{ states('input_datetime.flow_timer_start') }}"
   ```
6. Ersetze sie durch:
   ```yaml
   start_time: "{{ state_attr('input_datetime.flow_timer_start', 'timestamp') }}"
   ```
7. Suche die nÃ¤chste Zeile (ungefÃ¤hr Zeile 47):
   ```yaml
   elapsed_minutes: "{{ ((as_timestamp(now()) - as_timestamp(start_time)) / 60) | int }}"
   ```
8. Ersetze sie durch:
   ```yaml
   elapsed_minutes: "{{ ((as_timestamp(now()) - start_time) / 60) | int }}"
   ```
9. Klicke auf **SPEICHERN**

#### Automation 2: "Flow: Category Selection" aktualisieren

1. Gehe zu **Einstellungen** â†’ **Automationen & Szenen** â†’ **Automationen**
2. Suche die Automation **"Flow: Category Selection"**
3. Klicke darauf und dann auf die **drei Punkte** (â‹®) oben rechts
4. WÃ¤hle **"In YAML bearbeiten"**
5. Ersetze den kompletten YAML-Code mit diesem:

```yaml
alias: "Flow: Category Selection"
description: "Ensures only one category can be active at a time"
trigger:
  - platform: state
    entity_id:
      - input_boolean.flow_cat_work
      - input_boolean.flow_cat_personal
      - input_boolean.flow_cat_coding
      - input_boolean.flow_cat_design
      - input_boolean.flow_cat_other
    to: "on"
condition: []
action:
  - variables:
      triggered_entity: "{{ trigger.entity_id }}"
      category_map:
        input_boolean.flow_cat_work: Work
        input_boolean.flow_cat_personal: Personal
        input_boolean.flow_cat_coding: Coding
        input_boolean.flow_cat_design: Design
        input_boolean.flow_cat_other: Other
      selected_category: "{{ category_map[triggered_entity] }}"
  # First, turn off all other categories
  - service: input_boolean.turn_off
    target:
      entity_id: >
        {% set entities = [
          'input_boolean.flow_cat_work',
          'input_boolean.flow_cat_personal',
          'input_boolean.flow_cat_coding',
          'input_boolean.flow_cat_design',
          'input_boolean.flow_cat_other'
        ] %}
        {{ entities | reject('eq', triggered_entity) | list }}
  # Then ensure the selected category is ON (in case it was toggled off)
  - service: input_boolean.turn_on
    target:
      entity_id: "{{ triggered_entity }}"
  # Finally, update the active category text
  - service: input_text.set_value
    target:
      entity_id: input_text.flow_active_category
    data:
      value: "{{ selected_category }}"
mode: queued
max: 5
```

6. Klicke auf **SPEICHERN**

---

### Schritt 2: Testen

Nach den Ã„nderungen solltest du beide Funktionen testen:

#### Test 1: Timer-Tracking
1. WÃ¤hle eine Kategorie (z.B. "Work")
2. Starte den Timer
3. Warte mindestens 1 Minute
4. Stoppe den Timer
5. **ÃœberprÃ¼fe:** Die "Tracked Today" Zahl sollte sich jetzt erhÃ¶hen!

#### Test 2: Kategorie-Auswahl
1. Aktiviere "Work" â†’ Sollte ON sein, alle anderen OFF
2. Aktiviere "Personal" â†’ Sollte ON sein, "Work" und alle anderen OFF
3. Aktiviere schnell hintereinander mehrere Kategorien â†’ Am Ende sollte nur die letzte gewÃ¤hlte ON sein

---

## ğŸ“Š Technische Details (fÃ¼r Interessierte)

### Timer-Fix erklÃ¤rt
Der `input_datetime` Helfer in Home Assistant hat mehrere Attribute:
- `states('input_datetime.flow_timer_start')` gibt einen String zurÃ¼ck: "2024-10-29 19:30:00"
- `state_attr('input_datetime.flow_timer_start', 'timestamp')` gibt einen Unix-Timestamp zurÃ¼ck: 1698606600

Der `as_timestamp()` Filter kann nur mit dem zweiten Format arbeiten. Vorher wurde versucht, den String zwei Mal zu konvertieren, was zu einem Fehler fÃ¼hrte und `0` zurÃ¼ckgab.

### Kategorie-Fix erklÃ¤rt
Vorher:
1. Kategorie wird aktiviert â†’ Automation triggert
2. Automation schaltet andere aus
3. **Problem:** Die aktivierte Kategorie kÃ¶nnte in der Zwischenzeit wieder deaktiviert worden sein

Jetzt:
1. Kategorie wird aktiviert â†’ Automation triggert
2. Automation schaltet andere aus
3. **Neu:** Automation schaltet die gewÃ¤hlte explizit wieder ein
4. Kategorie-Text wird aktualisiert
5. **Neu:** Mode "queued" sorgt dafÃ¼r, dass mehrere schnelle Ã„nderungen nacheinander verarbeitet werden

---

## â“ HÃ¤ufige Fragen

### Muss ich Flow neu installieren?
**Nein!** Du musst nur die beiden Automationen aktualisieren. Alle Helfer und Sensoren bleiben unverÃ¤ndert.

### Was passiert mit meinen alten Daten?
**Nichts!** Deine Streak-Daten und gespeicherten Einstellungen bleiben erhalten.

### Was wenn ich die alten Automationen nicht mehr finde?
Kein Problem! Du kannst die Automationen auch komplett neu erstellen:
1. LÃ¶sche die alten Versionen
2. Folge den Anweisungen in der README.md ab Schritt 2.1 und 2.2
3. Verwende dabei die neuen YAML-Codes aus dieser Datei

### Funktioniert das auch mit Docker?
**Ja!** Diese Fixes funktionieren mit jeder Home Assistant Installation - Docker, Core, Supervised, OS - egal welche.

---

## ğŸ‰ Nach dem Update

Sobald du die Automationen aktualisiert hast, sollte Flow wie erwartet funktionieren:
- âœ… Timer-Stopps werden korrekt getrackt
- âœ… Nur eine Kategorie ist zur Zeit aktiv
- âœ… Dein Fortschritt wird korrekt angezeigt
- âœ… Streaks werden richtig gezÃ¤hlt

Viel Erfolg mit deinem produktiven Flow! ğŸš€

---

## ğŸ†˜ Support

Falls nach dem Update immer noch Probleme auftreten:

1. **ÃœberprÃ¼fe die Automation-Traces:**
   - Gehe zu der Automation
   - Klicke auf "Traces" 
   - Schau, ob Fehler angezeigt werden

2. **Starte Home Assistant neu:**
   - Einstellungen â†’ System â†’ Neu starten

3. **Ã–ffne ein Issue auf GitHub** mit:
   - Beschreibung des Problems
   - Screenshots der Automation-Traces
   - Deine Home Assistant Version

---

**Version:** v4.0.0  
**Datum:** Oktober 2024  
**Autor:** v-berlin
